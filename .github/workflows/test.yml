name: DB Migration Validation

on:
  pull_request:
    branches:
      - master

jobs:
  migration-validation:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Set up Docker (optional, usually pre-installed on ubuntu-latest)
      - name: Set up Docker
        run: docker --version

      # 3Ô∏è‚É£ Check if migration scripts exist
      - name: Check for migration scripts
        id: dbscripts
        run: |
          if [ -d "db/migrations" ] && [ "$(ls -A db/migrations/*.sql 2>/dev/null)" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      # 4Ô∏è‚É£ Start PostgreSQL container if scripts exist
      - name: Start PostgreSQL container
        if: steps.dbscripts.outputs.found == 'true'
        run: |
          docker run -d \
            --name migration-db \
            -e POSTGRES_USER=testuser \
            -e POSTGRES_PASSWORD=testpass \
            -e POSTGRES_DB=testdb \
            -p 5432:5432 \
            postgres:17

      # 5Ô∏è‚É£ Wait for DB readiness
      - name: Wait for DB readiness
        if: steps.dbscripts.outputs.found == 'true'
        run: |
          until docker exec migration-db pg_isready -U testuser; do
            echo "Waiting for PostgreSQL..."
            sleep 3
          done

      # 6Ô∏è‚É£ Run migrations
      - name: Run DB migrations with detailed errors
        if: steps.dbscripts.outputs.found == 'true'
        run: |
          set -e
          echo "Running migration scripts..."
      
          mkdir -p /tmp/db-validation
          : > /tmp/db-validation/success.txt
          : > /tmp/db-validation/fail.txt
          : > /tmp/db-validation/errors.txt
      
          for file in $(ls db/migrations/*.sql | sort); do
            echo "‚ñ∂ Running $file"
            ERROR=$(docker exec -i migration-db \
              psql -U testuser -d testdb -v ON_ERROR_STOP=1 < "$file" 2>&1) || true
      
            if [ $? -eq 0 ]; then
              echo "‚úÖ Success: $file"
              echo "$file" >> /tmp/db-validation/success.txt
            else
              echo "‚ùå Failed: $file"
              echo "$file" >> /tmp/db-validation/fail.txt
              {
                echo "### $file"
                echo "$ERROR"
              } >> /tmp/db-validation/errors.txt
            fi
          done
      
          # Fail pipeline if any migration failed
          if [ -s /tmp/db-validation/fail.txt ]; then
            exit 1
          fi

      - name: Run DB seeds
        if: steps.dbscripts.outputs.found == 'true' && hashFiles('db/seeds.sql') != ''
        run: |
          echo "Running seeds.sql"
          if docker exec -i migration-db \
            psql -U testuser -d testdb -v ON_ERROR_STOP=1 < db/seeds.sql 2>/tmp/db-validation/seeds_error.txt; then
            echo "PASS" > /tmp/db-validation/seeds_status.txt
          else
            echo "FAIL" > /tmp/db-validation/seeds_status.txt
          fi

      - name: DB Migration Validation Summary
        run: |
          VALIDATION_TIME=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
      
          echo "## üõ†Ô∏è Database Migration Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "**Validation Time:** $VALIDATION_TIME" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
          echo "### Migration Files Validation" >> $GITHUB_STEP_SUMMARY
          echo "| File | Type | Status | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|--------|-------|" >> $GITHUB_STEP_SUMMARY
      
          # Successful migrations
          if [ -f /tmp/db-validation/success.txt ]; then
            while read -r file; do
              echo "| $(basename "$file") | migration | PASS | None |" >> $GITHUB_STEP_SUMMARY
            done < /tmp/db-validation/success.txt
          fi
      
          # Failed migrations
          if [ -f /tmp/db-validation/fail.txt ]; then
            while read -r file; do
              ERROR=$(grep -A5 "$file" /tmp/db-validation/errors.txt | tr '\n' ' ')
              echo "| $(basename "$file") | migration | FAIL | $ERROR |" >> $GITHUB_STEP_SUMMARY
            done < /tmp/db-validation/fail.txt
          fi
      
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Seed File Validation" >> $GITHUB_STEP_SUMMARY
          echo "| File | Type | Status | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|--------|-------|" >> $GITHUB_STEP_SUMMARY
      
          if [ -f /tmp/db-validation/seeds_status.txt ]; then
            STATUS=$(cat /tmp/db-validation/seeds_status.txt)
            if [ "$STATUS" = "PASS" ]; then
              echo "| seeds.sql | seed | PASS | None |" >> $GITHUB_STEP_SUMMARY
            else
              NOTES=$(cat /tmp/db-validation/seeds_error.txt | tr '\n' ' ')
              echo "| seeds.sql | seed | FAIL | $NOTES |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| seeds.sql | seed | SKIPPED | File not found |" >> $GITHUB_STEP_SUMMARY
          fi
      
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -s /tmp/db-validation/fail.txt ] || [ "$(cat /tmp/db-validation/seeds_status.txt 2>/dev/null)" = "FAIL" ]; then
            echo "‚ö†Ô∏è Some migration/seed files failed validation." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ All migration and seed files validated successfully." >> $GITHUB_STEP_SUMMARY
          fi


      # 8Ô∏è‚É£ Cleanup
      - name: Stop and remove PostgreSQL container
        if: steps.dbscripts.outputs.found == 'true'
        run: |
          docker stop migration-db
          docker rm migration-db

