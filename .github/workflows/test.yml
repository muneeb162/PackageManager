name: DB Migration Validation

on:
  pull_request:
    branches:
      - master

jobs:
  migration-validation:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Set up Docker (optional, usually pre-installed on ubuntu-latest)
      - name: Set up Docker
        run: docker --version

      # 3Ô∏è‚É£ Check if migration scripts exist
      - name: Check for migration scripts
        id: dbscripts
        run: |
          if [ -d "db/migrations" ] && [ "$(ls -A db/migrations/*.sql 2>/dev/null)" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      # 4Ô∏è‚É£ Start PostgreSQL container if scripts exist
      - name: Start PostgreSQL container
        if: steps.dbscripts.outputs.found == 'true'
        run: |
          docker run -d \
            --name migration-db \
            -e POSTGRES_USER=testuser \
            -e POSTGRES_PASSWORD=testpass \
            -e POSTGRES_DB=testdb \
            -p 5432:5432 \
            postgres:17

      # 5Ô∏è‚É£ Wait for DB readiness
      - name: Wait for DB readiness
        if: steps.dbscripts.outputs.found == 'true'
        run: |
          until docker exec migration-db pg_isready -U testuser; do
            echo "Waiting for PostgreSQL..."
            sleep 3
          done

      # 6Ô∏è‚É£ Run migrations
      - name: Run DB migrations with detailed errors
        if: steps.dbscripts.outputs.found == 'true'
        run: |
          set -e
          echo "Running migration scripts..."
      
          SUCCESS=()
          FAIL=()
      
          for file in $(ls db/migrations/*.sql | sort); do
            echo "‚ñ∂ Running $file"
            ERROR=$(docker exec -i migration-db psql -U testuser -d testdb -v ON_ERROR_STOP=1 < "$file" 2>&1) || true
            if [ $? -eq 0 ]; then
              echo "‚úÖ Success: $file"
              SUCCESS+=("$file")
            else
              echo "‚ùå Failed: $file"
              echo "$ERROR" | while IFS= read -r line; do
                # Show lines with "LINE <n>:" from psql errors
                if [[ $line =~ LINE\ [0-9]+: ]]; then
                  echo "   $line"
                fi
              done
              FAIL+=("$file")
            fi
          done
      
          echo "--------------------------------------------------"
          echo "‚úÖ Successful migrations:"
          if [ ${#SUCCESS[@]} -eq 0 ]; then
            echo "None"
          else
            for s in "${SUCCESS[@]}"; do echo "- $s"; done
          fi
      
          echo "‚ùå Failed migrations:"
          if [ ${#FAIL[@]} -eq 0 ]; then
            echo "None"
          else
            for f in "${FAIL[@]}"; do echo "- $f"; done
          fi
      
          # Fail the step if there is any failure
          if [ ${#FAIL[@]} -ne 0 ]; then
            exit 1
          fi

      # 7Ô∏è‚É£ Run seeds (optional)
      - name: Run DB seeds
        if: steps.dbscripts.outputs.found == 'true' && hashFiles('db/seeds.sql') != ''
        run: |
          echo "Running seeds.sql"
          docker exec -i migration-db \
            psql -U testuser -d testdb -v ON_ERROR_STOP=1 < db/seeds.sql

      - name: DB Migration Validation Summary
        id: db_migration
        run: |
          set -e
          SUCCESSFUL=()
          FAILED=()
          
          echo "## üóÑÔ∏è Database Migration Validation" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ github.event.inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ github.event.inputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Validation Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
          for file in $(ls db/migrations/*.sql | sort); do
            echo "‚ñ∂ Running $file"
            if docker exec -i migration-db psql -U testuser -d testdb -v ON_ERROR_STOP=1 < "$file"; then
              echo "‚úÖ Success: $file"
              SUCCESSFUL+=("$file")
            else
              echo "‚ùå Failed: $file"
              FAILED+=("$file")
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          done
      
          echo "--------------------------------------------------" >> $GITHUB_STEP_SUMMARY
      
          # Show summary
          echo "### ‚úÖ Successful Migrations" >> $GITHUB_STEP_SUMMARY
          if [ ${#SUCCESSFUL[@]} -eq 0 ]; then
            echo "None" >> $GITHUB_STEP_SUMMARY
          else
            for s in "${SUCCESSFUL[@]}"; do
              echo "- $s" >> $GITHUB_STEP_SUMMARY
            done
          fi
      
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚ùå Failed Migrations" >> $GITHUB_STEP_SUMMARY
          if [ ${#FAILED[@]} -eq 0 ]; then
            echo "None" >> $GITHUB_STEP_SUMMARY
          else
            for f in "${FAILED[@]}"; do
              echo "- $f" >> $GITHUB_STEP_SUMMARY
            done
          fi
      
          # Set output for next jobs
          if [ ${#FAILED[@]} -gt 0 ]; then
            echo "migration_failed=true" >> $GITHUB_OUTPUT
          else
            echo "migration_failed=false" >> $GITHUB_OUTPUT
          fi

      # 8Ô∏è‚É£ Cleanup
      - name: Stop and remove PostgreSQL container
        if: steps.dbscripts.outputs.found == 'true'
        run: |
          docker stop migration-db
          docker rm migration-db

