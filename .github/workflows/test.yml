name: DB Migration Validation

on:
  pull_request:
    branches:
      - master

jobs:
  migration-validation:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Set up Docker (optional, usually pre-installed on ubuntu-latest)
      - name: Set up Docker
        run: docker --version

      # 3Ô∏è‚É£ Check if migration scripts exist
      - name: Check for migration scripts
        id: dbscripts
        run: |
          if [ -d "db/migrations" ] && [ "$(ls -A db/migrations/*.sql 2>/dev/null)" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      # 4Ô∏è‚É£ Start PostgreSQL container if scripts exist
      - name: Start PostgreSQL container
        if: steps.dbscripts.outputs.found == 'true'
        run: |
          docker run -d \
            --name migration-db \
            -e POSTGRES_USER=testuser \
            -e POSTGRES_PASSWORD=testpass \
            -e POSTGRES_DB=testdb \
            -p 5432:5432 \
            postgres:15

      # 5Ô∏è‚É£ Wait for DB readiness
      - name: Wait for DB readiness
        if: steps.dbscripts.outputs.found == 'true'
        run: |
          until docker exec migration-db pg_isready -U testuser; do
            echo "Waiting for PostgreSQL..."
            sleep 3
          done

      - name: Run DB migrations (proper error reporting)
        if: steps.dbscripts.outputs.found == 'true'
        run: |
          set +e
      
          echo "## üóÑÔ∏è Database Migrations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Script | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
      
          FAILED=0
          ERROR_BLOCK=""
      
          for file in $(ls db/migrations/*.sql 2>/dev/null | sort); do
            echo "‚ñ∂ Running $file"
      
            BASENAME=$(basename "$file")
      
            # Copy SQL file into container
            docker cp "$file" migration-db:/tmp/"$BASENAME"
      
            OUTPUT=$(docker exec migration-db \
              psql -U testuser -d testdb \
              -v ON_ERROR_STOP=1 \
              -v VERBOSITY=verbose \
              -f /tmp/"$BASENAME" 2>&1)
      
            if [ $? -eq 0 ]; then
              echo "| $file | ‚úÖ Success |" >> $GITHUB_STEP_SUMMARY
            else
              FAILED=1
              echo "| $file | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
      
              ERROR_BLOCK="${ERROR_BLOCK}
              ### ‚ùå ${file}
              \`\`\`
              ${OUTPUT}
              \`\`\`
              "
            fi
      
            # Cleanup copied file
            docker exec migration-db rm -f /tmp/"$BASENAME"
          done
      
          if [ $FAILED -ne 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## üîç Error Details" >> $GITHUB_STEP_SUMMARY
            echo "$ERROR_BLOCK" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ **All migration scripts executed successfully**" >> $GITHUB_STEP_SUMMARY
          fi




            # 7Ô∏è‚É£ Run DB seeds with summary
      - name: Run DB seeds (with summary)
        if: steps.dbscripts.outputs.found == 'true' && hashFiles('db/seeds/*.sql') != ''
        run: |
          set +e

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üå± Database Seeds" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Script | Status | Error |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|-------|" >> $GITHUB_STEP_SUMMARY

          FAILED=0

          for file in $(ls db/seeds/*.sql 2>/dev/null | sort); do
            echo "‚ñ∂ Running $file"

            OUTPUT=$(docker exec -i migration-db \
              psql -U testuser -d testdb -v ON_ERROR_STOP=1 < "$file" 2>&1)

            if [ $? -eq 0 ]; then
              echo "| $file | ‚úÖ Success | - |" >> $GITHUB_STEP_SUMMARY
            else
              FAILED=1
              ERROR=$(echo "$OUTPUT" | tail -n 8 | sed 's/|/\\|/g')
              echo "| $file | ‚ùå Failed | \`\`\`$ERROR\`\`\` |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          if [ $FAILED -ne 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ùå **One or more seed scripts failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ **All seed scripts applied successfully**" >> $GITHUB_STEP_SUMMARY
          fi

      # 8Ô∏è‚É£ Cleanup
      - name: Stop and remove PostgreSQL container
        if: steps.dbscripts.outputs.found == 'true'
        run: |
          docker stop migration-db
          docker rm migration-db
