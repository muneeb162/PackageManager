name: DB Migration Validation

on:
  pull_request:
    branches:
      - master

jobs:
  migration-validation:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Set up Docker (optional, usually pre-installed on ubuntu-latest)
      - name: Set up Docker
        run: docker --version

      # 3Ô∏è‚É£ Check if migration scripts exist
      - name: Check for migration scripts
        id: dbscripts
        run: |
          if [ -d "db/migrations" ] && [ "$(ls -A db/migrations/*.sql 2>/dev/null)" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      # 4Ô∏è‚É£ Start PostgreSQL container if scripts exist
      - name: Start PostgreSQL container
        if: steps.dbscripts.outputs.found == 'true'
        run: |
          docker run -d \
            --name migration-db \
            -e POSTGRES_USER=testuser \
            -e POSTGRES_PASSWORD=testpass \
            -e POSTGRES_DB=testdb \
            -p 5432:5432 \
            postgres:17

      # 5Ô∏è‚É£ Wait for DB readiness
      - name: Wait for DB readiness
        if: steps.dbscripts.outputs.found == 'true'
        run: |
          until docker exec migration-db pg_isready -U testuser; do
            echo "Waiting for PostgreSQL..."
            sleep 3
          done

      # 6Ô∏è‚É£ Run migrations
      - name: Run DB migrations with detailed errors
        if: steps.dbscripts.outputs.found == 'true'
        run: |
          set -e
          echo "Running migration scripts..."
      
          SUCCESS=()
          FAIL=()
      
          for file in $(ls db/migrations/*.sql | sort); do
            echo "‚ñ∂ Running $file"
            ERROR=$(docker exec -i migration-db psql -U testuser -d testdb -v ON_ERROR_STOP=1 < "$file" 2>&1) || true
            if [ $? -eq 0 ]; then
              echo "‚úÖ Success: $file"
              SUCCESS+=("$file")
            else
              echo "‚ùå Failed: $file"
              echo "$ERROR" | while IFS= read -r line; do
                # Show lines with "LINE <n>:" from psql errors
                if [[ $line =~ LINE\ [0-9]+: ]]; then
                  echo "   $line"
                fi
              done
              FAIL+=("$file")
            fi
          done
      
          echo "--------------------------------------------------"
          echo "‚úÖ Successful migrations:"
          if [ ${#SUCCESS[@]} -eq 0 ]; then
            echo "None"
          else
            for s in "${SUCCESS[@]}"; do echo "- $s"; done
          fi
      
          echo "‚ùå Failed migrations:"
          if [ ${#FAIL[@]} -eq 0 ]; then
            echo "None"
          else
            for f in "${FAIL[@]}"; do echo "- $f"; done
          fi
      
          # Fail the step if there is any failure
          if [ ${#FAIL[@]} -ne 0 ]; then
            exit 1
          fi

      # 7Ô∏è‚É£ Run seeds (optional)
      - name: Run DB seeds
        if: steps.dbscripts.outputs.found == 'true' && hashFiles('db/seeds.sql') != ''
        run: |
          echo "Running seeds.sql"
          docker exec -i migration-db \
            psql -U testuser -d testdb -v ON_ERROR_STOP=1 < db/seeds.sql

      - name: DB Migration Validation Summary
        id: db_migration
        run: |
          MIGRATION_DIR="db/migrations"
          SEED_FILE="db/seeds.sql"
          VALIDATION_TIME=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
      
          HAS_FAIL=false
      
          # Start GitHub Actions summary
          echo "## üõ†Ô∏è Database Migration Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "**Validation Time:** $VALIDATION_TIME" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
          echo "### Migration Files Validation" >> $GITHUB_STEP_SUMMARY
          echo "| File | Type | Status | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|--------|-------|" >> $GITHUB_STEP_SUMMARY
      
          for file in $MIGRATION_DIR/*.sql; do
            FILE_NAME=$(basename $file)
            TYPE="migration"
      
            # Dry-run check (replace with your actual validation command)
            if psql --dry-run -f "$file" 2>/tmp/db_errors.txt; then
              STATUS="PASS"
              NOTES="None"
            else
              STATUS="FAIL"
              NOTES=$(cat /tmp/db_errors.txt)
              HAS_FAIL=true
            fi
      
            echo "| $FILE_NAME | $TYPE | $STATUS | $NOTES |" >> $GITHUB_STEP_SUMMARY
          done
      
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Seed File Validation" >> $GITHUB_STEP_SUMMARY
          if [ -f "$SEED_FILE" ]; then
            TYPE="seed"
            if psql --dry-run -f "$SEED_FILE" 2>/tmp/db_errors.txt; then
              STATUS="PASS"
              NOTES="None"
            else
              STATUS="FAIL"
              NOTES=$(cat /tmp/db_errors.txt)
              HAS_FAIL=true
            fi
            echo "| $(basename $SEED_FILE) | $TYPE | $STATUS | $NOTES |" >> $GITHUB_STEP_SUMMARY
          fi
      
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$HAS_FAIL" = true ]; then
            echo "‚ö†Ô∏è Some migration/seed files failed validation. Please check above table." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ All migration and seed files validated successfully." >> $GITHUB_STEP_SUMMARY
          fi
      
          # Set output to use in next steps if needed
          echo "has_fail=$HAS_FAIL" >> $GITHUB_OUTPUT
        shell: bash

      # 8Ô∏è‚É£ Cleanup
      - name: Stop and remove PostgreSQL container
        if: steps.dbscripts.outputs.found == 'true'
        run: |
          docker stop migration-db
          docker rm migration-db

