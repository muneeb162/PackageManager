name: Secret Scan on Pull Request (TruffleHog3 Binary)

on:
  pull_request:
    branches:
      - master

jobs:
  trufflehog3-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout full repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install TruffleHog v3 Binary
        run: |
          wget https://github.com/trufflesecurity/trufflehog/releases/latest/download/trufflehog_3_linux_amd64.tar.gz
          tar -xzf trufflehog_3_linux_amd64.tar.gz
          sudo mv trufflehog /usr/local/bin/trufflehog3
          trufflehog3 --version

      - name: Run TruffleHog3 Scan on PR Commits
        run: |
          echo "üîç Scanning PR commits for secrets..."
          trufflehog3 git \
            --since-commit ${{ github.event.pull_request.base.sha }} \
            --until-commit ${{ github.event.pull_request.head.sha }} \
            --only-verified \
            --json --output trufflehog3_results.json || true

          echo "üìÑ Generating HTML report..."
          trufflehog3 -R trufflehog3_results.json --output trufflehog3_report.html

      - name: Fail if secrets found
        run: |
          if [ -s trufflehog3_results.json ]; then
            echo "‚ùå Secrets detected in PR changes!"
            exit 1
          else
            echo "‚úÖ No secrets found."
          fi

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog3-scan-reports
          path: |
            trufflehog3_results.json
            trufflehog3_report.html
