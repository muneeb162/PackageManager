name: Secret Scan (TruffleHog3)

on:
  pull_request:
    branches: [ main, master ]

permissions: 
  contents: read 
  id-token: write 
  issues: write 
  pull-requests: write 
  
jobs:
  trufflehog_scan:
    name: Scan and Generate HTML Report
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python Report Generator (trufflehog3)
        run: pip install trufflehog3

      - name: Get changed files in PR
        id: changed_files
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git diff --name-only origin/${{ github.event.pull_request.base.ref }} > changed_files.txt
          cat changed_files.txt

      # - name: Create Artifact Directory
      #   run: mkdir -p trufflehog_reports

      - name: Run TruffleHog3 scan only on changed files
        run: |
          mkdir -p trufflehog_reports
          xargs -a changed_files.txt -I {} bash -c 'if [ -f "{}" ]; then trufflehog3 --zero --no-entropy --no-history --rules rules.yml --format JSON -o trufflehog_reports/$(basename {}).json {}; fi'
          trufflehog3 -R trufflehog_reports/ --output trufflehog_reports/report.html

      # - name: Run trufflehog3 scan
      #   run: |
      #         rm -rf backend/node_modules
      #         trufflehog3 --zero --no-entropy --no-history --rules rules.yml --format JSON -o trufflehog_reports/report.json .          
      #         trufflehog3 -R trufflehog_reports/report.json --output trufflehog_reports/report.html

      # - name: Generate HTML Report from JSON
      #   run: |
      #     trufflehog3 -R trufflehog_reports/report.json --output trufflehog_reports/report.html

      - name: Upload HTML Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TruffleHog-v3-HTML-Report
          path: trufflehog_reports/report.html
          retention-days: 7

      - name: Upload Raw JSON Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TruffleHog-v3-Raw-JSON
          path: trufflehog_reports/report.json

      - name: Fail if secrets found
        run: |
          if grep -q '"severity":' trufflehog_reports/report.json; then
            echo "❌ Potential secrets detected! Check trufflehog_reports/report.json"
            exit 1
          else
            echo "✅ No secrets found."
          fi
