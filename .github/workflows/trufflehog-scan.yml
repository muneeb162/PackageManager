name: Secret Scan on PR (TruffleHog)

on:
  pull_request:
    branches:
      - master

jobs:
  trufflehog-scan:
    name: Run TruffleHog v3 on PR changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install TruffleHog v3 and Python deps
        run: |
          python3 -m pip install --upgrade pip
          pip install trufflehog

      - name: Run TruffleHog and generate JSON report
        run: |
          echo "🔍 Running TruffleHog scan on PR..."
          trufflehog git file://. --since-commit origin/master --branch ${{ github.head_ref }} --json > trufflehog_report.json || true

      - name: Convert JSON to HTML report
        run: |
          cat <<'EOF' > generate_html.py
          import json, html

          with open("trufflehog_report.json") as f:
              data = [json.loads(line) for line in f if line.strip()]

          html_content = """<html><head>
          <meta charset='UTF-8'>
          <title>TruffleHog Secret Scan Report</title>
          <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          h1 { color: #333; }
          table { border-collapse: collapse; width: 100%; margin-top: 20px; }
          th, td { border: 1px solid #ddd; padding: 8px; }
          th { background-color: #333; color: white; text-align: left; }
          tr:nth-child(even) { background-color: #f2f2f2; }
          pre { background: #f8f8f8; padding: 8px; border-radius: 6px; overflow-x: auto; }
          </style></head><body>
          <h1>🔒 TruffleHog Secret Scan Report</h1>
          <p>Scanned branch: <b>${{ github.head_ref }}</b></p>
          <table><tr><th>#</th><th>File</th><th>Line</th><th>Detector</th><th>Raw Secret</th><th>Commit</th></tr>"""
          
          if not data:
              html_content += "<tr><td colspan='6' style='text-align:center;'>✅ No secrets found</td></tr>"
          else:
              for i, finding in enumerate(data, 1):
                  meta = finding.get("SourceMetadata", {}).get("Data", {})
                  html_content += f"<tr><td>{i}</td><td>{meta.get('file','N/A')}</td><td>{meta.get('line','N/A')}</td>"
                  html_content += f"<td>{finding.get('DetectorName','Unknown')}</td>"
                  secret = html.escape(finding.get('Raw','')[:80])
                  html_content += f"<td><pre>{secret}</pre></td><td>{meta.get('commit','N/A')}</td></tr>"
          html_content += "</table></body></html>"
          open("trufflehog_report.html","w").write(html_content)
          EOF

          python3 generate_html.py

      - name: Convert JSON to SARIF (for GitHub code scanning)
        run: |
          cat <<'EOF' > json_to_sarif.py
          import json
          data = []
          with open("trufflehog_report.json") as f:
              for line in f:
                  if line.strip():
                      data.append(json.loads(line))

          sarif = {
              "version": "2.1.0",
              "runs": [{
                  "tool": {"driver": {"name": "TruffleHog", "informationUri": "https://github.com/trufflesecurity/trufflehog"}},
                  "results": []
              }]
          }

          for finding in data:
              meta = finding.get("SourceMetadata", {}).get("Data", {})
              sarif["runs"][0]["results"].append({
                  "ruleId": finding.get("DetectorName", "Unknown"),
                  "message": {"text": f"Potential secret in {meta.get('file','N/A')}"},
                  "locations": [{
                      "physicalLocation": {
                          "artifactLocation": {"uri": meta.get("file", "unknown")},
                          "region": {"startLine": meta.get("line", 0)}
                      }
                  }]
              })

          with open("trufflehog.sarif", "w") as out:
              json.dump(sarif, out, indent=2)
          EOF

          python3 json_to_sarif.py

      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-html-report
          path: trufflehog_report.html

      - name: Upload SARIF to GitHub Security tab
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trufflehog.sarif
