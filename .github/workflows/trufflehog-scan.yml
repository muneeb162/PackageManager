name: Secret Scan (TruffleHog3 - PR Changes Only)

on:
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  id-token: write
  issues: write
  pull-requests: write

jobs:
  trufflehog_scan:
    name: Scan Only Changed Files with TruffleHog3
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # full history so git diff works

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install TruffleHog3
        run: pip install trufflehog3

      - name: Fetch base branch for diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Get changed files in PR
        id: changes
        run: |
          git diff --name-only --diff-filter=AM origin/${{ github.event.pull_request.base.ref }}...HEAD > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt
          echo "files=$(cat changed_files.txt | xargs)" >> $GITHUB_OUTPUT

      - name: Run TruffleHog3 scan on changed files
        run: |
          mkdir -p trufflehog_reports
          if [ ! -s changed_files.txt ]; then
            echo "‚úÖ No changed files detected. Skipping scan."
            exit 0
          fi

          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "üîç Scanning $file..."
              mkdir -p temp_scan
              cp "$file" temp_scan/
              trufflehog3 --zero --no-entropy --no-history \
                --rules rules.yml \
                --format JSON \
                -o trufflehog_reports/$(basename "$file").json \
                temp_scan/
              rm -rf temp_scan
            fi
          done < changed_files.txt

          # Merge all small JSONs into one (simple concatenation)
          jq -s '.' trufflehog_reports/*.json > trufflehog_reports/report.json

      - name: Generate HTML Report
        run: |
          trufflehog3 -R trufflehog_reports/report.json --output trufflehog_reports/report.html

      - name: Upload HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: TruffleHog3-HTML-Report
          path: trufflehog_reports/report.html
          retention-days: 7

      - name: Upload Raw JSON Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TruffleHog3-Raw-JSON
          path: trufflehog_reports/report.json

      - name: Fail if secrets found
        run: |
          if grep -q '"severity":' trufflehog_reports/report.json; then
            echo "‚ùå Potential secrets detected! Check trufflehog_reports/report.json"
            exit 1
          else
            echo "‚úÖ No secrets found."
          fi
