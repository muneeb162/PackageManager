name: TruffleHog v3 HTML Artifact Generator üêΩüîë

on:
  pull_request:
    branches:
      - master

permissions:
  contents: read 
  
jobs:
  trufflehog_scan:
    name: Scan and Generate HTML Report
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for accurate diff scanning
          fetch-depth: 0 

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python Report Generator (trufflehog3)
        # Install the Python package that converts JSON to HTML
        run: pip install trufflehog3

      - name: Create Artifact Directory
        run: mkdir -p reports

      # 1. RUN OFFICIAL TRUFFLEHOG v3 ACTION (CORRECTED)
      # The action handles the complex git diff arguments internally.
      - name: Run TruffleHog Scan and Save JSON
        id: trufflehog_scan
        # Use the official action for easy PR diff scanning
        uses: trufflesecurity/trufflehog@main 
        continue-on-error: true # Allow subsequent steps to run
        with:
          # Pass the PR references directly to the action
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          # Output to JSON format and redirect to the file
          output_format: json 
          output_file: reports/results.json
          # Set fail=false to ensure the workflow continues to the artifact steps 
          extra_args: --fail=false

      # 2. Convert JSON Report to HTML using trufflehog3
      - name: Generate HTML Report from JSON
        run: |
          # Use the installed trufflehog3 Python command to render the report
          trufflehog3 -R reports/results.json --output reports/report.html
      
      # 3. Upload the HTML Report as a Downloadable Artifact
      - name: Upload HTML Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TruffleHog-v3-HTML-Report
          path: reports/report.html
          retention-days: 7

      # 4. Upload the raw JSON file 
      - name: Upload Raw JSON Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TruffleHog-v3-Raw-JSON
          path: reports/results.json
