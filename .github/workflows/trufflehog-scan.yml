name: TruffleHog v3 HTML Artifact Generator üêΩüîë

on:
  pull_request:
    branches:
      - master

permissions:
  contents: read 
  
jobs:
  trufflehog_scan:
    name: Scan and Generate HTML Report
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for accurate diff scanning
          fetch-depth: 0 

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python Report Generator (trufflehog3)
        # Install the Python package that converts JSON to HTML
        run: pip install trufflehog3

      - name: Create Artifact Directory
        run: mkdir -p trufflehog_reports

      - name: Run trufflehog3 scan
        run: |
          trufflehog3 --no-entropy --no-pattern --format JSON -o trufflehog_reports/report.json . 

      # 2. Convert JSON Report to HTML using trufflehog3
      - name: Generate HTML Report from JSON
        run: |
          # Use the installed trufflehog3 Python command to render the report
          trufflehog3 -R trufflehog_reports/results.json --output trufflehog_reports/report.html
      
      # 3. Upload the HTML Report as a Downloadable Artifact
      - name: Upload HTML Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TruffleHog-v3-HTML-Report
          path: trufflehog_reports/report.html
          retention-days: 7

      # 4. Upload the raw JSON file 
      - name: Upload Raw JSON Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TruffleHog-v3-Raw-JSON
          path: trufflehog_reports/results.json
